@page "/campaigns/{CampaignId:guid}"
@using PathfinderCampaignManager.Presentation.Client.Components.Auth
@using PathfinderCampaignManager.Presentation.Client.Components.RealTime
@using PathfinderCampaignManager.Presentation.Client.Services
@inject IJSRuntime JSRuntime
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IAuthenticationService AuthService
@using System.Text.Json
@using System.Net.Http.Headers
@implements IAsyncDisposable

<PageTitle>@(_campaign?.Name ?? "Campaign") - Pathfinder Campaign Manager</PageTitle>

<AuthGuard CustomMessage="You must be logged in to view campaign details." RedirectToLogin="true">

<div class="container-fluid">
    @if (_isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading campaign...</span>
            </div>
            <p class="mt-3 text-muted">Loading campaign details...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="alert alert-danger" role="alert">
            @_errorMessage
        </div>
    }
    else if (_campaign != null)
    {
        <div class="row mb-4">
            <div class="col">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/campaigns">Campaigns</a></li>
                        <li class="breadcrumb-item active" aria-current="page">@_campaign.Name</li>
                    </ol>
                </nav>
                <div class="d-flex justify-content-between align-items-center">
                    <h1 class="display-6">
                        <i class="fas fa-dragon me-2"></i>
                        @_campaign.Name
                    </h1>
                    @if (_isDM)
                    {
                        <div class="btn-group">
                            <a href="/campaigns/@CampaignId/manage" class="btn btn-outline-primary">
                                <i class="fas fa-cogs me-2"></i>
                                Manage
                            </a>
                            <button class="btn btn-primary" @onclick="StartSession">
                                <i class="fas fa-play me-2"></i>
                                Start Session
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Campaign Info -->
            <div class="col-lg-8">
                @if (!string.IsNullOrEmpty(_campaign.Description))
                {
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-scroll me-2"></i>
                                Campaign Description
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="card-text">@_campaign.Description</p>
                        </div>
                    </div>
                }

                <!-- Quick Actions -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-bolt me-2"></i>
                            Quick Actions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <a href="/characters/create?campaignId=@CampaignId" class="btn btn-outline-success w-100">
                                    <i class="fas fa-user-plus mb-2 d-block"></i>
                                    Create Character
                                </a>
                            </div>
                            <div class="col-md-4">
                                <a href="/campaigns/@CampaignId/monsters/create" class="btn btn-outline-danger w-100">
                                    <i class="fas fa-dragon mb-2 d-block"></i>
                                    Add Monster
                                </a>
                            </div>
                            <div class="col-md-4">
                                <a href="/rules" class="btn btn-outline-info w-100">
                                    <i class="fas fa-book mb-2 d-block"></i>
                                    Rules Reference
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Premade Encounters (DM Only) -->
                @if (_isDM && _premadeEncounters.Any())
                {
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-swords me-2"></i>
                                Premade Encounters
                                @if (_isStartingEncounter)
                                {
                                    <span class="spinner-border spinner-border-sm ms-2" role="status" aria-label="Starting encounter..."></span>
                                }
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                @foreach (var encounter in _premadeEncounters.OrderBy(e => e.PartyLevel))
                                {
                                    <div class="col-lg-6">
                                        <div class="card h-100 border-secondary">
                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                <h6 class="mb-0">@encounter.Name</h6>
                                                <div>
                                                    <span class="badge bg-info me-2">Level @encounter.PartyLevel</span>
                                                    <span class="badge @GetDifficultyBadgeClass(encounter.Difficulty)">@encounter.Difficulty</span>
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <p class="card-text small text-muted mb-3">@encounter.Description</p>
                                                @if (encounter.MonsterTemplates.Any())
                                                {
                                                    <div class="mb-3">
                                                        <strong class="small">Monsters:</strong>
                                                        <ul class="list-unstyled small ms-2 mb-0">
                                                            @foreach (var monster in encounter.MonsterTemplates)
                                                            {
                                                                <li>
                                                                    <i class="fas fa-dragon me-1 text-danger"></i>
                                                                    @monster.Name @(monster.Count > 1 ? $"(x{monster.Count})" : "") 
                                                                    <span class="text-muted">- Level @monster.Level @monster.Type</span>
                                                                </li>
                                                            }
                                                        </ul>
                                                    </div>
                                                }
                                                <button class="btn btn-danger btn-sm w-100" 
                                                        @onclick="@(() => StartPremadeEncounter(encounter.Id))"
                                                        disabled="@_isStartingEncounter">
                                                    <i class="fas fa-play me-1"></i>
                                                    Start Encounter
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }

                <!-- Recent Activity -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-clock me-2"></i>
                            Recent Activity
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="text-center py-4 text-muted">
                            <i class="fas fa-calendar-times fa-3x mb-3"></i>
                            <p>No recent activity</p>
                            <small>Activity will appear here as players interact with the campaign</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Campaign Stats -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-bar me-2"></i>
                            Campaign Overview
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="stat-number">@_campaign.MemberCount</div>
                                <div class="stat-label">Members</div>
                            </div>
                            <div class="col-4">
                                <div class="stat-number">@_campaign.SessionCount</div>
                                <div class="stat-label">Sessions</div>
                            </div>
                            <div class="col-4">
                                <div class="stat-number">
                                    @if (_campaign.LastActivityAt.HasValue)
                                    {
                                        @GetDaysSince(_campaign.LastActivityAt.Value)
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </div>
                                <div class="stat-label">Days Since Activity</div>
                            </div>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">Created:</span>
                            <span>@_campaign.CreatedAt.ToString("MMM dd, yyyy")</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted">Status:</span>
                            <span class="badge @(_campaign.IsActive ? "bg-success" : "bg-secondary")">
                                @(_campaign.IsActive ? "Active" : "Inactive")
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Members -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-users me-2"></i>
                            Members (@_campaign.MemberCount)
                        </h5>
                        @if (_isDM)
                        {
                            <button class="btn btn-sm btn-outline-primary" @onclick="ShowInviteModal">
                                <i class="fas fa-user-plus"></i>
                            </button>
                        }
                    </div>
                    <div class="card-body">
                        <div class="text-center py-3 text-muted">
                            <i class="fas fa-users-slash fa-2x mb-2"></i>
                            <p class="mb-0">Member list coming soon</p>
                        </div>
                    </div>
                </div>

                <!-- Campaign Characters -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-users-cog me-2"></i>
                            Characters (@_campaignCharacters.Count)
                        </h5>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-success" @onclick="ShowJoinWithCharacterModal">
                                <i class="fas fa-plus"></i>
                            </button>
                            <a href="/campaigns/@CampaignId/characters/create" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-user-plus"></i>
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        @if (_campaignCharacters.Any())
                        {
                            <div class="characters-list">
                                @foreach (var character in _campaignCharacters)
                                {
                                    <div class="character-item d-flex justify-content-between align-items-center py-2 border-bottom">
                                        <div class="character-info">
                                            <div class="character-name fw-bold">@character.Name</div>
                                            <div class="character-details text-muted">
                                                Level @character.Level @character.Class
                                                @if (!string.IsNullOrEmpty(character.Ancestry))
                                                {
                                                    <span> • @character.Ancestry</span>
                                                }
                                            </div>
                                        </div>
                                        <div class="character-actions">
                                            <a href="/characters/@character.Id" class="btn btn-sm btn-outline-info me-2">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            @if (_currentUser?.Id.ToString() == character.Id.ToString() || _isDM)
                                            {
                                                <button class="btn btn-sm btn-outline-danger" @onclick="@(() => RemoveCharacterFromCampaign(character.Id))">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-3 text-muted">
                                <i class="fas fa-user-slash fa-2x mb-2"></i>
                                <p class="mb-0">No characters in this campaign yet</p>
                                <small>Join with an existing character or create a new one</small>
                            </div>
                        }
                    </div>
                </div>

                <!-- Variant Rules -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-magic me-2"></i>
                            Variant Rules
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="text-center py-3 text-muted">
                            <i class="fas fa-scroll fa-2x mb-2"></i>
                            <p class="mb-0">Using standard Pathfinder 2e rules</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<!-- SignalR Status Panel -->
@if (_campaign != null && _currentUser != null)
{
    <CampaignStatusPanel CampaignId="@CampaignId.ToString()"
                         UserId="@_currentUser.Id.ToString()" 
                         UserName="@_currentUser.DisplayName" />
}

</AuthGuard>

<style>
    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: #495057;
    }

    .stat-label {
        font-size: 0.875rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .btn-outline-success:hover,
    .btn-outline-danger:hover,
    .btn-outline-info:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .card {
        border: none;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
    }
</style>

